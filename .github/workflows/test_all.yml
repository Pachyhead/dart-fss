name: Test Target Unit Functionality

on:
  push:
    branches: [ main, develop, feat/*, fix/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  test-target-unit:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: Create test directory
      run: |
        mkdir -p test_output
        
    - name: Create target unit test script
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        cat > test_target_units.py << 'EOF'
        import dart_fss as dart
        import os
        import sys
        import json
        import time
        
        # GitHub Secretsì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
        api_key = os.environ.get('DART_API_KEY', '')
        if not api_key:
            print("âŒ No API key provided")
            sys.exit(1)
            
        print("ğŸ”‘ Setting API key...")
        dart.set_api_key(api_key=api_key)
        
        # í…ŒìŠ¤íŠ¸í•  ë‹¨ìœ„ë“¤ ì •ì˜
        valid_units = ['ì›', 'ì‹­ì›', 'ë°±ì›', 'ì²œì›', 'ë§Œì›', 'ì‹­ë§Œì›', 'ë°±ë§Œì›', 'ì²œë§Œì›', 'ì–µì›']
        invalid_units = ['ì‹­ì–µì›', 'ì¡°ì›', 'ë¬´íš¨ë‹¨ìœ„', 'ë‹¬ëŸ¬']
        
        test_results = {
            'valid_tests': {},
            'invalid_tests': {},
            'errors': []
        }
        
        try:
            print("ğŸ“‹ Loading corporation list...")
            corp_list = dart.get_corp_list()
            print("âœ… Corporation list loaded successfully")
            
            print("ğŸ” Searching for Samsung Electronics...")
            samsung = corp_list.find_by_corp_name('ì‚¼ì„±ì „ì', exactly=True)[0]
            print(f"âœ… Samsung Electronics found: {samsung.corp_name}")
            
            # ìœ íš¨í•œ ë‹¨ìœ„ë“¤ í…ŒìŠ¤íŠ¸
            print("\nğŸ§ª Testing valid units...")
            for unit in valid_units:
                try:
                    print(f"  ğŸ“Š Testing unit: {unit}")
                    
                    # ì¬ë¬´ì œí‘œ ì¶”ì¶œ
                    fs = samsung.extract_fs(bgn_de='20240101', target_unit=unit)
                    print(f"    âœ… Extract successful for {unit}")
                    
                    # JSON íŒŒì¼ë¡œ ì €ì¥
                    filename = f"test_{unit.replace('ì›', 'won')}.json"
                    saved_files = fs.save(filename=filename, path='test_output')
                    print(f"    âœ… Save successful for {unit}")
                    
                    # ì €ì¥ëœ íŒŒì¼ í™•ì¸
                    if saved_files and len(saved_files) > 0:
                        print(f"    ğŸ“„ Generated {len(saved_files)} files")
                        
                        # ì²« ë²ˆì§¸ íŒŒì¼ì˜ ë‚´ìš© í™•ì¸
                        if saved_files[0].endswith('.json'):
                            with open(saved_files[0], 'r', encoding='utf-8') as f:
                                data = json.load(f)
                                target_unit_info = data.get('info', {}).get('target_unit', 'Not found')
                                print(f"    ğŸ“‹ Target unit in file: {target_unit_info}")
                    
                    test_results['valid_tests'][unit] = {
                        'status': 'success',
                        'files_generated': len(saved_files) if saved_files else 0
                    }
                    
                    # ë©”ëª¨ë¦¬ ì •ë¦¬ë¥¼ ìœ„í•œ ì ì‹œ ëŒ€ê¸°
                    time.sleep(1)
                    
                except Exception as e:
                    error_msg = f"Failed to process unit {unit}: {str(e)}"
                    print(f"    âŒ {error_msg}")
                    test_results['valid_tests'][unit] = {
                        'status': 'failed',
                        'error': str(e)
                    }
                    test_results['errors'].append(error_msg)
            
            # ë¬´íš¨í•œ ë‹¨ìœ„ë“¤ í…ŒìŠ¤íŠ¸ (ValueError ë°œìƒ í™•ì¸)
            print("\nğŸš« Testing invalid units...")
            for unit in invalid_units:
                try:
                    print(f"  ğŸ§ª Testing invalid unit: {unit}")
                    
                    # ì´ ë¶€ë¶„ì—ì„œ ValueErrorê°€ ë°œìƒí•´ì•¼ í•¨
                    fs = samsung.extract_fs(bgn_de='20240101', target_unit=unit)
                    
                    # ì—¬ê¸°ê¹Œì§€ ì˜¤ë©´ ì•ˆë¨ (ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ)
                    error_msg = f"ERROR: {unit} should have raised ValueError but didn't"
                    print(f"    âŒ {error_msg}")
                    test_results['invalid_tests'][unit] = {
                        'status': 'unexpected_success',
                        'error': 'Should have failed but succeeded'
                    }
                    test_results['errors'].append(error_msg)
                    
                except ValueError as e:
                    # ì˜ˆìƒëœ ì—ëŸ¬ - ì •ìƒ
                    print(f"    âœ… Correctly rejected {unit}: {str(e)}")
                    test_results['invalid_tests'][unit] = {
                        'status': 'correctly_rejected',
                        'error_message': str(e)
                    }
                    
                except Exception as e:
                    # ì˜ˆìƒí•˜ì§€ ëª»í•œ ì—ëŸ¬
                    error_msg = f"Unexpected error for {unit}: {str(e)}"
                    print(f"    âŒ {error_msg}")
                    test_results['invalid_tests'][unit] = {
                        'status': 'unexpected_error',
                        'error': str(e)
                    }
                    test_results['errors'].append(error_msg)
            
            # ê²°ê³¼ ìš”ì•½
            print("\nğŸ“Š Test Summary:")
            valid_success = sum(1 for result in test_results['valid_tests'].values() 
                              if result['status'] == 'success')
            invalid_success = sum(1 for result in test_results['invalid_tests'].values() 
                                if result['status'] == 'correctly_rejected')
            
            print(f"  âœ… Valid units successful: {valid_success}/{len(valid_units)}")
            print(f"  âœ… Invalid units correctly rejected: {invalid_success}/{len(invalid_units)}")
            print(f"  âŒ Total errors: {len(test_results['errors'])}")
            
            # ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥
            with open('test_output/test_results.json', 'w', encoding='utf-8') as f:
                json.dump(test_results, f, ensure_ascii=False, indent=2)
            
            # ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬
            if test_results['errors']:
                print("\nâŒ Test failed with errors:")
                for error in test_results['errors']:
                    print(f"  â€¢ {error}")
                sys.exit(1)
            else:
                print("\nğŸ‰ All tests completed successfully!")
                
        except SystemExit as e:
            if 'trading halt' in str(e).lower() or 'ê±°ë˜ì •ì§€' in str(e):
                print("âŒ Trading halt error handling test failed")
                print(f"Error: {e}")
                sys.exit(1)
            else:
                raise  # ë‹¤ë¥¸ SystemExitì€ ê·¸ëŒ€ë¡œ ì „íŒŒ
        except Exception as e:
            print(f"âŒ Unexpected error occurred: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
        
    - name: Run target unit tests
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        python test_target_units.py 2>&1 | grep -v -E "(Loading|spinner|[â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â ]|\r|Loading Stock Market Information)" || true
        
    - name: Verify test results
      run: |
        echo "ğŸ“ Checking test results:"
        if [ -f "test_output/test_results.json" ]; then
          echo "âœ… Test results file generated"
          echo "ğŸ“‹ Test results summary:"
          python -c "
        import json
        with open('test_output/test_results.json', 'r', encoding='utf-8') as f:
            results = json.load(f)
        
        print(f'Valid units tested: {len(results[\"valid_tests\"])}')
        print(f'Invalid units tested: {len(results[\"invalid_tests\"])}')
        print(f'Total errors: {len(results[\"errors\"])}')
        
        valid_success = sum(1 for r in results['valid_tests'].values() if r['status'] == 'success')
        invalid_success = sum(1 for r in results['invalid_tests'].values() if r['status'] == 'correctly_rejected')
        
        print(f'Valid units success rate: {valid_success}/{len(results[\"valid_tests\"])}')
        print(f'Invalid units rejection rate: {invalid_success}/{len(results[\"invalid_tests\"])}')
        
        if results['errors']:
            print('âŒ Errors found:')
            for error in results['errors']:
                print(f'  â€¢ {error}')
            exit(1)
        else:
            print('âœ… All tests passed!')
          "
        else
          echo "âŒ Test results file not generated"
          exit 1
        fi
        
    - name: Verify generated files
      run: |
        echo "ğŸ“ Checking generated JSON files:"
        if [ -d "test_output" ]; then
          ls -la test_output/
          
          json_count=$(find test_output -name "*.json" -not -name "test_results.json" | wc -l)
          echo "ğŸ“„ Generated JSON files: $json_count"
          
          if [ $json_count -gt 0 ]; then
            echo "âœ… Financial statement files generated successfully"
            for file in test_output/*.json; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "test_results.json" ]; then
                size=$(du -h "$file" | cut -f1)
                echo "ğŸ“„ $(basename "$file"): $size"
                
                # JSON íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
                if python -c "import json; json.load(open('$file', 'r', encoding='utf-8'))" 2>/dev/null; then
                  echo "  âœ… Valid JSON"
                else
                  echo "  âŒ Invalid JSON"
                  exit 1
                fi
              fi
            done
          else
            echo "âŒ No financial statement JSON files generated"
            exit 1
          fi
        else
          echo "âŒ Output directory not created"
          exit 1
        fi
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: target-unit-test-outputs-py${{ matrix.python-version }}
        path: test_output/
        retention-days: 7
        
    - name: Display test summary
      if: always()
      run: |
        echo "ğŸ¯ Target Unit Test Summary for Python ${{ matrix.python-version }}:"
        echo "=================================="
        if [ -f "test_output/test_results.json" ]; then
          python -c "
        import json
        try:
            with open('test_output/test_results.json', 'r', encoding='utf-8') as f:
                results = json.load(f)
            
            print('ğŸ“Š Detailed Results:')
            print()
            print('âœ… Valid Units:')
            for unit, result in results['valid_tests'].items():
                status = 'âœ…' if result['status'] == 'success' else 'âŒ'
                print(f'  {status} {unit}: {result[\"status\"]}')
            
            print()
            print('ğŸš« Invalid Units:')
            for unit, result in results['invalid_tests'].items():
                status = 'âœ…' if result['status'] == 'correctly_rejected' else 'âŒ'
                print(f'  {status} {unit}: {result[\"status\"]}')
                
        except Exception as e:
            print(f'Error reading test results: {e}')
          "
        else
          echo "âŒ No test results available"
        fi
