name: Test DART-FSS Integration with Trading Halt Error Handling

on:
  push:
    branches: [ fix/trading-halt-error-handling ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  test-prac01:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        
    - name: Create test directory
      run: |
        mkdir -p test_output
        
    - name: Create modified prac01.py for testing
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        cat > test_prac01.py << 'EOF'
        import dart_fss as dart
        import os
        import sys
        
        # GitHub Secretsì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
        api_key = os.environ.get('DART_API_KEY', '')
        if not api_key:
            print("âŒ No API key provided")
            sys.exit(1)
            
        print("ğŸ”‘ Setting API key...")
        dart.set_api_key(api_key=api_key)
        
        try:
            print("ğŸ“‹ Loading corporation list...")
            corp_list = dart.get_corp_list()
            print("âœ… Corporation list loaded successfully")
            
            print("ğŸ” Searching for Samsung Electronics...")
            samsung = corp_list.find_by_corp_name('ì‚¼ì„±ì „ì', exactly=True)[0]
            print(f"âœ… Samsung Electronics found: {samsung.corp_name}")
            
            print("ğŸ“Š Extracting financial statements from 2024...")
            fs = samsung.extract_fs(bgn_de='20240101')
            print("âœ… Financial statements extracted successfully")
            
            print("ğŸ’¾ Saving financial statements...")
            saved_path = fs.save(path='test_output')
            print(f"âœ… Financial statements saved to: {saved_path}")
            
            print("ğŸ‰ All tests completed successfully!")
            
        except SystemExit as e:
            if 'trading halt' in str(e).lower() or 'ê±°ë˜ì •ì§€' in str(e):
                print("âŒ Trading halt error handling test failed")
                print(f"Error: {e}")
                sys.exit(1)
            else:
                print(f"âŒ Unexpected system exit: {e}")
                sys.exit(1)
        except Exception as e:
            print(f"âŒ Error occurred: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
        
    - name: Run prac01.py test (CI environment auto-skip)
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
        GITHUB_ACTIONS: true  # ëª…ì‹œì ìœ¼ë¡œ ì„¤ì • (ì´ë¯¸ ìë™ìœ¼ë¡œ ì„¤ì •ë˜ì§€ë§Œ)
      run: |
        # CI í™˜ê²½ì—ì„œëŠ” ìë™ìœ¼ë¡œ ê±°ë˜ì •ì§€ ëª©ë¡ ì¡°íšŒë¥¼ ê±´ë„ˆë›°ë¯€ë¡œ ì‚¬ìš©ì ì…ë ¥ ë¶ˆí•„ìš”
        python test_prac01.py 2>&1 | grep -v -E "(Loading|spinner|[â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â ]|\r)" || true
        
    - name: Verify output files
      run: |
        echo "ğŸ“ Checking generated files:"
        if [ -d "test_output" ]; then
          ls -la test_output/
          if [ -n "$(ls -A test_output)" ]; then
            echo "âœ… Output files generated successfully"
            for file in test_output/*; do
              if [ -f "$file" ]; then
                echo "ğŸ“„ Generated: $(basename "$file") ($(du -h "$file" | cut -f1))"
              fi
            done
          else
            echo "âŒ No output files generated"
            exit 1
          fi
        else
          echo "âŒ Output directory not created"
          exit 1
        fi
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: test_output/
        retention-days: 7
