name: Test DART-FSS Integration with Trading Halt Error Handling

on:
  push:
    branches: [ fix/trading-halt-error-handling ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  test-prac01:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas beautifulsoup4 lxml requests openpyxl
        
    - name: Create test directory
      run: |
        mkdir -p test_output
        
    - name: Create modified prac01.py for testing
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        cat > test_prac01.py << 'EOF'
        import sys
        import os 
        
        # dart-fss ê²½ë¡œ ì„¤ì •
        path_to_cloned_dart_fss = os.path.abspath('.')
        sys.path.insert(0, path_to_cloned_dart_fss)
        
        import dart_fss as dart
        
        # GitHub Secretsì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
        api_key = os.environ.get('DART_API_KEY', '')
        if not api_key:
            print("âŒ No API key provided")
            sys.exit(1)
            
        print("ðŸ”‘ Setting API key...")
        dart.set_api_key(api_key=api_key)
        
        try:
            print("ðŸ“‹ Loading corporation list...")
            corp_list = dart.get_corp_list()
            print("âœ… Corporation list loaded successfully")
            
            print("ðŸ” Searching for Samsung Electronics...")
            samsung = corp_list.find_by_corp_name('ì‚¼ì„±ì „ìž', exactly=True)[0]
            print(f"âœ… Samsung Electronics found: {samsung.corp_name}")
            
            print("ðŸ“Š Extracting financial statements from 2024...")
            fs = samsung.extract_fs(bgn_de='20240101')
            print("âœ… Financial statements extracted successfully")
            
            print("ðŸ’¾ Saving financial statements...")
            # ì €ìž¥ ê²½ë¡œë¥¼ test_outputìœ¼ë¡œ ë³€ê²½
            saved_path = fs.save(path='test_output')
            print(f"âœ… Financial statements saved to: {saved_path}")
            
            print("ðŸŽ‰ All tests completed successfully!")
            
        except SystemExit as e:
            if 'trading halt' in str(e).lower() or ' ê±°ëž˜ì •ì§€' in str(e):
                print("âŒ Trading halt error handling test failed")
                print(f"Error: {e}")
                sys.exit(1)
            else:
                print(f"âŒ Unexpected system exit: {e}")
                sys.exit(1)
        except Exception as e:
            print(f"âŒ Error occurred: {e}")
            import traceback
            traceback.print_exc()
            sys.exit(1)
        EOF
        
    - name: Run prac01.py test
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        python test_prac01.py
        
    - name: Verify output files
      run: |
        echo "ðŸ“ Checking generated files:"
        if [ -d "test_output" ]; then
          ls -la test_output/
          if [ -n "$(ls -A test_output)" ]; then
            echo "âœ… Output files generated successfully"
            for file in test_output/*; do
              if [ -f "$file" ]; then
                echo "ðŸ“„ Generated: $(basename "$file") ($(du -h "$file" | cut -f1))"
              fi
            done
          else
            echo "âŒ No output files generated"
            exit 1
          fi
        else
          echo "âŒ Output directory not created"
          exit 1
        fi
        
    - name: Test trading halt error handling specifically
      env:
        DART_API_KEY: ${{ secrets.DART_API_KEY }}
      run: |
        cat > test_error_handling.py << 'EOF'
        import sys
        import os
        
        path_to_cloned_dart_fss = os.path.abspath('.')
        sys.path.insert(0, path_to_cloned_dart_fss)
        
        import dart_fss as dart
        
        api_key = os.environ.get('DART_API_KEY', '')
        dart.set_api_key(api_key=api_key)
        
        print("ðŸ§ª Testing error handling improvements...")
        
        # ì´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤ì œë¡œ ê±°ëž˜ì •ì§€ ì‚¬ì´íŠ¸ê°€ ì •ìƒì´ë©´ í†µê³¼í•˜ê³ ,
        # ì‚¬ì´íŠ¸ì— ë¬¸ì œê°€ ìžˆìœ¼ë©´ ìš°ë¦¬ì˜ ì—ëŸ¬ í•¸ë“¤ë§ì´ ì œëŒ€ë¡œ ìž‘ë™í•˜ëŠ”ì§€ í™•ì¸
        try:
            corp_list = dart.get_corp_list()
            print("âœ… CorpList initialization completed without errors")
            print("â„¹ï¸  Trading halt site appears to be working normally")
        except SystemExit as e:
            print(f"âŒ SystemExit occurred (this should not happen with our fix): {e}")
            sys.exit(1)
        except Exception as e:
            print(f"âŒ Unexpected error: {e}")
            sys.exit(1)
        
        print("âœ… Error handling test passed")
        EOF
        
        python test_error_handling.py
        
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs
        path: test_output/
        retention-days: 7
